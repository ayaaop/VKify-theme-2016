{extends "../@layout.xml"}
{block title}{_menu_help}{/block}

{block content}
    {include "../components/page_crumb_header.xml", crumbs: [
        ['href' => "/support?act=list", 'title' => tr("support_tickets")],
        ['title' => $ticket->getName()]
    ]}
    <script>
        function markAnswer(id, mark) {
            let url = "/support/comment/" + id + "/rate/" + mark + "?hash=" + {urlencode($csrfToken)};
            $.ajax(url, {
                error: errorHandler,
                success: success(id, mark)
            });
        }

        function success(id, mark) {
            if(mark == 1)
                document.getElementById("markText-" + id).innerHTML = {_support_good_answer_user};
            else
                document.getElementById("markText-" + id).innerHTML = {_support_bad_answer_user};

            document.getElementById("markLinks-" + id).remove();
        }

        function errorHandler(id, mark) {
            document.getElementById("markText-" + id).innerHTML = {_error};
        }

        function closeTicket() {
            let url = `/support/ticket${{$ticket->getId()}}/close?hash=${{urlencode($csrfToken)}}`;
            $.ajax(url, {
                error: () => alert(tr("error")),
                success: () => location.reload()
            });
        }
    </script>
    {if $ticket->isDeleted() == 0}
    <div class="page_block tickets_content">
        <div class="tickets_header_container">
            <div class="tickets_header clear_fix">
                <div class="tickets_header_body">
                    <div class="tickets_header_title">{$ticket->getName()}</div>
                    <div class="tickets_header_info">{$ticket->getStatus()} {if $ticket->getUser()->isBanned()}<span class="divider"></span> <strong><a onclick="$('#ban-reason').toggle();">{_admin_banned}</a></strong>{/if}</div>
                </div>
                <div class="tickets_header_links">
                    <a href="/support/delete/{$id}?hash={$csrfToken}">{_delete}</a>
                </div>
            </div>
        </div>
        <div class="post reply" id="_ticket{$id}">
            <div class="reply_wrap">
                <a class="reply_image" href="/id{$ticket->getUser()->getId()}">
                    <img src="{if str_contains($ticket->getUser()->getAvatarUrl('miniscule'), 'camera_200.png')}/themepack/vkify16/{$theme->getVersion()}/resource/camera_200.png{else}{$ticket->getUser()->getAvatarUrl('miniscule')}{/if}"
                         width="30"
                         class="reply_img" />
                </a>
                <div class="reply_content">
                    <div class="reply_author">
                        <a class="author" href="/id{$ticket->getUser()->getId()}">
                            {$ticket->getUser()->getCanonicalName()}
                        </a>
                        {if $ticket->getUser()->isVerified()}
                            <a class="page_verified" href="/verify"></a>
                        {/if}
                    </div>
                    <div class="post-content" id="ticket{$id}">
                        <div class="text reply_text">
                            <div class="really_text">
                                {$ticket->getText()|noescape}
                            </div>
                        </div>
                    </div>
                    <div class='post_edit'></div>
                    <div class="reply_footer clear_fix">
                        <div class="reply_date">
                            <a href="#ticket{$id}" class="reply_link">
                                {$ticket->getTime()}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            <p n:if="!$comments">{_no_comments}</p>
            {var $printedSupportGreeting = false}
            <div n:foreach="$comments as $comment" class="post reply" id="_comment{$comment->getId()}" data-comment-id="{$comment->getId()}">
                <div class="reply_wrap">
                    <a class="reply_image" href="{if $comment->getUType() === 0}{$comment->getUser()->getURL()}{/if}">
                        <img src="{if $comment->getUType() === 0}{if str_contains($comment->getUser()->getAvatarUrl('miniscule'), 'camera_200.png')}/themepack/vkify16/{$theme->getVersion()}/resource/camera_200.png{else}{$comment->getUser()->getAvatarUrl('miniscule')}{/if}{else}{$comment->getAvatar()}{/if}"
                                width="30"
                                class="reply_img"
                                style="{if $comment->getUType() === 1}filter: hue-rotate({$comment->getColorRotation()}deg);{/if}" />
                    </a>
                    <div class="reply_content">
                        <div class="fl_r reply_actions_wrap">
                            <div class="reply_actions" n:if="isset($thisUser)">
                                <a n:if="$comment->getUType() === 0" class="reply_action reply_delete_action" href="/support/comment/{$comment->getId()}/delete?hash={rawurlencode($csrfToken)}" data-tip="simple-black" data-tiptitle="{_delete}"></a>
                            </div>
                        </div>
                        <div class="reply_author">
                            {if $comment->getUType() === 0}
                                <a class="author" href="{$comment->getUser()->getURL()}">
                                    {$comment->getUser()->getCanonicalName()}
                                </a>
                                {if $comment->getUser()->isVerified()}
                                    <a class="page_verified" href="/verify"></a>
                                {/if}
                            {else}
                                <a class="author">
                                    <b>{$comment->getAuthorName()}</b>
                                </a>
                            {/if}
                        </div>
                        <div class="post-content" id="{$comment->getId()}">
                            <div class="text reply_text" id="text{$comment->getId()}">
                                <div class="really_text">
                                    {if $comment->getUType() === 1 && !$printedSupportGreeting}
                                        {var $printedSupportGreeting = true}
                                        {tr("support_greeting_hi", $ticket->getUser()->getFullName())}
                                        <br />
                                        <br />

                                        {$comment->getText()|noescape}
                                        <br />
                                        <br />

                                        {tr("support_greeting_regards", OPENVK_ROOT_CONF["openvk"]["appearance"]["name"])|noescape}
                                    {else}
                                        {$comment->getText()|noescape}
                                    {/if}
                                </div>
                            </div>
                        </div>
                        <div class='post_edit'></div>
                        <div class="reply_footer clear_fix">
                            <div class="reply_date">
                                <a href="#_comment{$comment->getId()}" class="reply_link">
                                    {$comment->getTime()}
                                </a>
                            </div>
                            {if $comment->getUType() === 1}
                                <div class="post-menu fl_r">
                                    {var $isLikedByUser = $comment->isLikedByUser()}
                                    <span id="markText-{$comment->getId()}">
                                    {if !is_null($isLikedByUser)}
                                        {if $comment->isLikedByUser()}
                                            {_support_good_answer_user}
                                        {else}
                                            {_support_bad_answer_user}
                                        {/if}
                                    {/if}
                                    </span>
                                    <div id="markLinks-{$comment->getId()}">
                                        {if is_null($isLikedByUser)}
                                            <a onClick="markAnswer({$comment->getId()}, 1)">{_support_rate_good_answer}</a>
                                            |
                                            <a onClick="markAnswer({$comment->getId()}, 2)">{_support_rate_bad_answer}</a>
                                        {/if}
                                    </div>
                                </div>
                            {/if}
                        </div>
                    </div>
                </div>
            </div>
            <div id="standaloneCommentBox" class="model_content_textarea shown clear_fix" n:if="$ticket->getType() !== 2">
                <form action="/al_comments/create/support/{$id}" method="post" style="margin:0;">
                    <textarea name="text" style="width: 100%;resize: vertical;" placeholder="{_reply}"></textarea>
                    <input type="hidden" name="hash" value="{$csrfToken}" />
                    <div class="post-buttons">
                        <div class="post-bottom-acts">
                            <div class="post-attach-menu">
                                {if $ticket->getType() === 1}{_you_can_close_this_ticket_1} <a onClick="closeTicket()">{_you_can_close_this_ticket_2}</a>.{/if}
                            </div>
                            <div class="post-bottom-buttons">
                                <input class="button" type="submit" value="{_write}" class="button" />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    {/if}
{/block}
