{extends "../@layout.xml"}

{if !$user->isBanned()}
    {var $backdrops = $user->getBackDropPictureURLs()}
{/if}

{block title}{$user->getCanonicalName()}{/block} 

{block headIncludes}
    {if $user->getPrivacyPermission('page.read', $thisUser ?? NULL)}
    <!-- openGraph -->
    <meta property="og:title" content="{$user->getCanonicalName()}" />
    <meta property="og:url" content="http://{$_SERVER['HTTP_HOST']}{$user->getURL()}" />
    <meta property="og:image" content="{$user->getAvatarUrl('normal')}" />
    <meta property="og:type" content="profile" />
    <meta property="og:first_name" content="{$user->getFirstName()}" />
    <meta property="og:last_name" content="{$user->getLastName()}" />
    <meta n:if="!is_null($user->getShortcode())" property="og:username" content="{$user->getShortcode()}" />
    <meta property="og:gender" content="{($user->isFemale() ? 'fe' : '')}male" />
    
    <!-- json-ld -->
    <script type="application/ld+json">
        {
            "@context": "http://schema.org/",
            "type": "Person",
            "name": {$user->getCanonicalName()},
            "url": {('http://') . $_SERVER['HTTP_HOST'] . $user->getURL()}
        }
    </script>
    {else} 
    <meta name="robots" content="noindex, noarchive">
    {/if}
{/block}

{block header}
    {$user->getCanonicalName()}
    <img n:if="$user->isVerified()"
         class="name-checkmark"
         src="/assets/packages/static/openvk/img/checkmark.png"
         />
    <span n:if="isset($thisUser) && $user->getId() == $thisUser->getId()"><b>({_this_is_you})</b></span>
    
    <!-- DEBUG: ONLINE REPORT: static {$user->getOnline()->timestamp()}s adjusted {$user->getOnline()->timestamp() + 2505600}s real {time()}s -->
    <div n:if="$user->getOnline()->timestamp() + 2505600 > time()" style="float:right;">
        {if $user->isOnline()}
            <span><b>{_online}</b></span>
        {else}
            <span>{$user->isFemale() ? tr("was_online_f") : tr("was_online_m")} {$user->getOnline()}</span>
        {/if}
        {var $platform = $user->getOnlinePlatform()}
        {var $platformDetails = $user->getOnlinePlatformDetails()}
        <a n:if="!empty($platform)" class="client_app client_app_titlebar" data-app-tag="{$platform}" data-app-name="{$platformDetails['name']}" data-app-url="{$platformDetails['url']}" data-app-img="{$platformDetails['img']}">
            <img src="/assets/packages/static/openvk/img/app_icons_mini/{$user->getOnlinePlatform(this)}.svg">
        </a>
    </div>
    <div n:if="$user->onlineStatus() == 2" style="float:right;">
        <span><b>{_deceased_person}</b></span>
    </div>
{/block}

{block content}
    {if !$user->isBanned()}
    
    {if !$user->getPrivacyPermission('page.read', $thisUser ?? NULL)}
        <div class="msg msg_err">
            <b>{_forbidden}</b><br/>
            {_forbidden_comment}
        </div>
    {else}
    
    <div class="left_small_block">
        <div class="avatar_block">
            {var $hasAvatar = !str_contains($user->getAvatarUrl('miniscule'), "/assets/packages/static/openvk/img/camera_200.png")}
            
            {if $thisUser && $user->getId() == $thisUser->getId()}
                <a {if $hasAvatar}style="display:none"{/if} class="add_image_text" id="add_image">{_add_image}</a>
                <div {if !$hasAvatar}style="display:none"{/if} class="avatar_controls">
                    <div class="avatarDelete hoverable"></div>
                    <div class="avatar_variants">
                        <a class="_add_image hoverable" id="add_image"><span>{_upload_new_picture}</span></a>
                    </div>
                </div>
            {/if}
            <a href="{$user->getAvatarLink()|nocheck}">
                <img src="{$user->getAvatarUrl('normal')}"
                     alt="{$user->getCanonicalName()}"
                     id="bigAvatar"
                     style="width: 100%; image-rendering: -webkit-optimize-contrast;"
					 {if ($user->getAvatarPhoto())}
					 onclick="OpenMiniature(event, {$user->getAvatarUrl('normal')}, null, {$user->getAvatarPhoto()->getPrettyId()}, null)" />
					 {/if}
            </a>
        </div>
		{if $user->getId() != $thisUser->getId()}
		
		<div class="frenMenu">
			<a n:if="$user->getPrivacyPermission('messages.write', $thisUser)" href="/im?sel={$user->getId()}" rel="nofollow">
				<input value="{_send_message}" class="button" type="submit" style="margin: 0px 8px 8px 8px; height: 28px;" />
			</a>
			{var $subStatus = $user->getSubscriptionStatus($thisUser)}
			{if $subStatus === 0}
				<form action="/setSub/user" method="post" class="profile_link_form">
					<input type="hidden" name="act" value="add" />
					<input type="hidden" name="id"  value="{$user->getId()}" />
					<input type="hidden" name="hash" value="{$csrfToken}" />
					<input type="submit" value="{_friends_add}" class="button" />
				</form>
			{elseif $subStatus === 1}
				<form action="/setSub/user" method="post" class="profile_link_form">
					<input type="hidden" name="act" value="add" />
					<input type="hidden" name="id"  value="{$user->getId()}" />
					<input type="hidden" name="hash" value="{$csrfToken}" />
					<input type="submit" value="{_friends_accept}" class="button" />
				</form>
			{elseif $subStatus === 2}
				<form action="/setSub/user" method="post" class="profile_link_form">
					<input type="hidden" name="act" value="rem" />
					<input type="hidden" name="id"  value="{$user->getId()}" />
					<input type="hidden" name="hash" value="{$csrfToken}" />
					<input type="submit" value="{_friends_reject}" class="button" />
				</form>
			{elseif $subStatus === 3}
				<form action="/setSub/user" method="post" class="profile_link_form">
					<input type="hidden" name="act" value="rem" />
					<input type="hidden" name="id"  value="{$user->getId()}" />
					<input type="hidden" name="hash" value="{$csrfToken}" />
					<input type="submit" value="{_friends_delete}" class="button" />
				</form>
			{/if}
		</div>
		{/if}
        <div n:ifset="$thisUser" id="profile_links">
            {if $user->getId() == $thisUser->getId()}
                <div id="profile_link" style="width: 200px;">
                    <a href="/edit" class="link">{_edit_page}</a>
                </div>
            {else}
                {if $thisUser->getChandlerUser()->can("access")->model("admin")->whichBelongsTo(NULL)}
				<a class="profile_link" onclick="document.querySelector('.profile_openmenu').style.display = 'block';" style="display: block; width: 96%; user-select: none !important;">
					{_admin_actions}
				</a>
					<div class="profile_openmenu" style="display: none;">
						<div class="sett_selected" onclick="document.querySelector('.profile_openmenu').style.display = 'none';">
							{_admin_actions}
						</div>
						{if $thisUser->getChandlerUser()->can("substitute")->model('openvk\Web\Models\Entities\User')->whichBelongsTo(0)}
							<a href="/setSID/{$user->getChandlerUser()->getId()}?hash={rawurlencode($csrfToken)}">
								<div class="sett_hover">
									<span>{tr("login_as", $user->getFirstName())}</span>
								</div>
							</a>
						{/if}
						<a href="/admin/users/id{$user->getId()}">
							<div class="sett_hover">
									<span>{_manage_user_action}</span>
							</div>
						</a>
						<a href="javascript:banUser()">
							<div class="sett_hover">
								<span>{_ban_user_action}</span>
							</div>
						</a>
						<a href="javascript:warnUser()">
							<div class="sett_hover">
									<span>{_warn_user_action}</span>
							</div>
						</a>
						<a href="/admin/user{$user->getId()}/bans">
							<div class="sett_hover">
									<span>{_blocks}</span>
							</div>
						</a>
						<a href="/admin/logs?uid={$user->getId()}">
							<div class="sett_hover">
									<span>{_last_actions}</span>
							</div>
						</a>
						{if $thisUser->getChandlerUser()->can('write')->model('openvk\Web\Models\Entities\TicketReply')->whichBelongsTo(0)}
							<a href="javascript:toggleBanInSupport()" style="width: 200px;">
								<div class="sett_hover">
									<span>
								{if $user->isBannedInSupport()}
									{_unban_in_support_user_action}
								{else}
									{_ban_in_support_user_action}
								{/if}
									</span>
								</div>
							</a>
						{/if}
					</div>
                {/if}

                <a n:if="!$blacklist_status" id="_bl_toggler" data-name="{$user->getMorphedName('genitive', false)}" data-val="1" data-id="{$user->getRealId()}" class="profile_link" style="display:block;width:96%;">{_bl_add}</a>
                {* 4 admins *}
                <a n:if="$blacklist_status" id="_bl_toggler" data-val="0" data-id="{$user->getRealId()}" class="profile_link" style="display:block;width:96%;">{_bl_remove}</a>
                <a class="profile_link" style="display:block;width:96%;" href="javascript:reportUser({$user->getId()})">{_report}</a>
                <a n:if="!$user->isHideFromGlobalFeedEnabled()" class="profile_link" style="display:block;width:96%;" id="__ignoreSomeone" data-val='{!$ignore_status ? 1 : 0}' data-id="{$user->getId()}">
                    {if !$ignore_status}{_ignore_user}{else}{_unignore_user}{/if}
                </a>
            {/if}
			<div n:if="((new \openvk\Web\Models\Repositories\Photos())->getUserPhotosCount($user) > 0 && $user->getPrivacyPermission('photos.read', $thisUser ?? NULL)) || ((new \openvk\Web\Models\Repositories\Videos())->getUserVideosCount($user) > 0 && $user->getPrivacyPermission('videos.read', $thisUser ?? NULL)) || ($user->getFollowersCount() > 0 && $user->getPrivacyPermission('friends.read', $thisUser ?? NULL))" style="border-bottom: 1px #d7d7d7 solid !important;height: 0px !important;"></div>
            <a style="width: 200px;" n:if="(new \openvk\Web\Models\Repositories\Photos())->getUserPhotosCount($user) > 0 && $user->getPrivacyPermission('photos.read', $thisUser ?? NULL)" href="/albums{$user->getId()}" class="profile_link">
				{tr("mobile_photos")} <div class="smallIcon photos"></div> <span class="count_small">{(new \openvk\Web\Models\Repositories\Photos())->getUserPhotosCount($user)}</span>
			</a>
            <a style="width: 200px;" n:if="(new \openvk\Web\Models\Repositories\Videos())->getUserVideosCount($user) > 0 && $user->getPrivacyPermission('videos.read', $thisUser ?? NULL)" href="/videos{$user->getId()}" class="profile_link">
				{tr("videos")} <div class="smallIcon videos"></div> <span class="count_small">{(new \openvk\Web\Models\Repositories\Videos())->getUserVideosCount($user)}</span>
			</a>
            <a style="width: 200px;" n:if="$user->getFollowersCount() > 0 && $user->getPrivacyPermission('friends.read', $thisUser ?? NULL)" href="/friends{$user->getId()}?act=incoming" class="profile_link">
				{tr("followers")} <div class="smallIcon fans"></div> <span class="count_small">{$user->getFollowersCount()}</span>
			</a>
        </div>
        <div n:if="isset($thisUser) && !$thisUser->prefersNotToSeeRating()" class="profile-hints">
            {var $completeness = $user->getProfileCompletenessReport()}
            
            <div  onClick="showIncreaseRatingDialog({$thisUser->getCoins()}, {ltrim($user->getUrl(), '/')}, {$csrfToken})" n:class="completeness-gauge, $completeness->total >= 100 ? completeness-gauge-gold">
                <div style="width: {$completeness->percent}%"></div>
                <span>{$completeness->total}%</span>
            </div>
            
            {if isset($thisUser) && $user->getId() === $thisUser->getId() && sizeof($completeness->unfilled) > 0}
                <br/>
                <a class="profile_link" n:if="in_array('interests', $completeness->unfilled)" href="/edit?act=interests">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAALCAMAAACecocUAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAtUExURZuzy+Tr8X6cvMfU4unu85auyIaiwKm80svX5Iumw6K4z67B1YShv9jh6wAAAC4S9fIAAAAPdFJOU///////////////////ANTcmKEAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABGSURBVBhXTctJDsAwCEPR5JOpGbj/cRtoU9UL9CTsoJbfjcTPghynTE7mwkkJWl9W64hzL6zvfrYNLmjuztBBd8+1/2uq3hnBBD6c8rEtAAAAAElFTkSuQmCC" />
                    {_interests} <div class="unfilled_rating">+20%</div>
                </a>
                <a class="profile_link" n:if="in_array('email', $completeness->unfilled)" href="/edit?act=contacts">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAALCAYAAACtWacbAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAA5SURBVChTY+xYcug/AxCUR9sydi49DGYjA3lxfgYmkCSUjxU8fPmRgQmbbnRA0CQQGOEmyYvzMwAA2ygeSD2uvVcAAAAASUVORK5CYII=" />
                    Email <div class="unfilled_rating">+20%</div>
                </a>
                <a class="profile_link" n:if="in_array('phone', $completeness->unfilled)" href="/edit?act=contacts">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAcAAAALCAMAAACETmeaAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAnUExURYikwq7B1ZWuyJStyJKsx5evypuyzI+pxpKrx5Cqxq/C1pyzzAAAANFi/csAAAANdFJOU////////////////wA96CKGAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAANklEQVQYVy2MWxIAIAgCMXpYef/zRtYy44ofIi4IGC6ahWTVSt353b67PNx9ylhKsp9ezz+wA0C6ATp2Uub9AAAAAElFTkSuQmCC" />
                    {_phone} <div class="unfilled_rating">+20%</div>
                </a>
                <a class="profile_link" n:if="in_array('telegram', $completeness->unfilled)" href="/edit?act=contacts">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAALCAMAAABxsOwqAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAABIUExURezw86e80qu/1IynxJewytzk7rfI2YikwpKrx6W60ZWuyK3A1Ymlw7PE2Ont8bbH2cPR4I+pxtvj7Iumw9Ld6J2zzZavyQAAAAvdZhwAAAAYdFJOU///////////////////////////////AM0TLuoAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABLSURBVBhXJczhEkAwDAPgYgTbig19/zfVRv/ku9ylYibDOKXZ02yB30puwUTuwUyGUMgcrKQWL5W0ChweYnpe/qA5W+cM/ZbnF/B+Yc8F4jyCJDYAAAAASUVORK5CYII=" />
                    Telegram <div class="unfilled_rating">+15%</div>
                </a>
                <a class="profile_link" n:if="in_array('status', $completeness->unfilled)" href="/edit">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAALCAMAAACecocUAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAASUExURc7Z5qG3z4ikwuDn76q+1AAAAOEOjSUAAAAGdFJOU///////ALO/pL8AAAAJcEhZcwAADsMAAA7DAcdvqGQAAAA0SURBVBhXVc1RDgAgCAJQobj/lXNMy/h6boqhTuA6yPLaTOfcGfw9dySQdeu212nXL9jSAWFZAXT3w/ZAAAAAAElFTkSuQmCC" />
                    {_status} <div class="unfilled_rating">+15%</div>
                </a>
            {/if}
        </div>
        <br />
		<div class="leftDataBlock">
			<div class="giftsDataBlock" n:if="OPENVK_ROOT_CONF['openvk']['preferences']['commerce'] && ($giftCount = $user->getGiftCount()) > 0">
				<a href="/gifts{$user->getId()}">
					<div class="content_title_expanded">
						{_gifts}
					</div>
				</a>
				<div>
					<a href="/gifts{$user->getId()}">
						<div class="content_subtitle">
							{tr("gifts", $giftCount)}
						</div>
					</a>
					<div class="content_list long">
						<div class="cl_element" style="width: 58px;" n:foreach="$user->getGifts(1, 3) as $giftDescriptor">
							{var $hideInfo = !is_null($thisUser) ? ($giftDescriptor->anon ? $thisUser->getId() !== $user->getId() : false) : false}
							<div class="cl_avatar">
								<a href="{$hideInfo ? 'javascript:false' : $giftDescriptor->sender->getURL()}">
									<img style="max-width: 58px;"
										src="{$giftDescriptor->gift->getImage(2)}"
										alt="{$hideInfo ? tr('gift') : ($giftDescriptor->caption ?? tr('gift'))}" 
										title="{$hideInfo ? tr('gift') : ($giftDescriptor->caption ?? tr('gift'))}" loading=lazy />
								</a>  
							</div>
						</div>
					</div>
				</div>
			{if $user->getId() != $thisUser->getId()}
				<div class="sendGift" n:if="OPENVK_ROOT_CONF['openvk']['preferences']['commerce']">
					<a href="/gifts?act=pick&user={$user->getId()}" class="sendGiftlnk">{tr("send_gift")}</a>
				</div>
			{/if}
			</div>
			<a href="/friends{$user->getId()}" n:if="$user->getFriendsCount() > 0 && $user->getPrivacyPermission('friends.read', $thisUser ?? NULL)">
				<div>
					{var $friendCount = $user->getFriendsCount()}
					<div class="content_title_expanded">
						{_friends}
					</div>
					<div>
						<div class="content_subtitle">
							{tr("friends", $friendCount)}
							<div style="float:right;">
							</div>
						</div>
						<div class="content_list">
							<div class="cl_element" n:foreach="$user->getFriends(1) as $friend">
								<div class="cl_avatar">
									<a href="{$friend->getURL()}">
										<img class="ava" src="{$friend->getAvatarUrl('miniscule')}" />
									</a>
								</div>
								<a href="{$friend->getURL()}" class="cl_name">
									<text class="cl_fname">{$friend->getFirstName()}</text>
									<text class="cl_lname">{$friend->getLastName()}</text>
								</a>    
							</div>
						</div>
					</div>
				</div>
			</a>
			<a href="/friends{$user->getId()}?act=online">
				<div n:if="$thisUser != NULL && $thisUser->getId() == $user->getId() && $user->getFriendsOnlineCount() > 0">
					{var $friendOnlineCount = $user->getFriendsOnlineCount()}
					
					<div class="content_title_expanded">
						{_friends_online}
					</div>
					<div>
						<div class="content_subtitle">
							{tr("friends_online", $friendOnlineCount)}
						</div>
						<div class="content_list">
							<div class="cl_element" n:foreach="$user->getFriendsOnline(1) as $friend">
								<div class="cl_avatar">
									<a href="{$friend->getURL()}">
										<img class="ava" src="{$friend->getAvatarUrl('miniscule')}" />
									</a>
								</div>
								<a href="{$friend->getURL()}" class="cl_name">
									<text class="cl_fname">{$friend->getFirstName()}</text>
									<text class="cl_lname">{$friend->getLastName()}</text>
								</a>    
							</div>
						</div>
					</div>
				</div>
			</a>
			<div n:if="$audiosCount > 0 && $user->getPrivacyPermission('audios.read', $thisUser ?? NULL)">
				<a href="/audios{$user->getId()}">
					<div class="content_title_expanded">
						{_audios}
					</div>
				</a>
				<div>
					<a href="/audios{$user->getId()}">
						<div class="content_subtitle">
							{tr("audios_count", $audiosCount)}
						</div>
					</a>
					<div class="content_list long">
						<div class="audio" n:foreach="$audios as $audio" style="width: 200px;">
							{include "../Audio/player.xml", audio => $audio}
						</div>
					</div>
				</div>
			</div>
			<a href="/albums{$user->getId()}" n:if="$albumsCount > 0 && $user->getPrivacyPermission('photos.read', $thisUser ?? NULL)">
				<div>
					<div class="content_title_expanded">
						{_albums}
					</div>
					<div>
						<div class="content_subtitle">
							{tr("albums", $albumsCount)}
						</div>
						<div style="padding-left: 10px; padding-bottom: 10px;">
							<a n:foreach="$albums as $album" href="/album{$album->getPrettyId()}">
								<div class="ovk-album" style="display: inline-block;">
									{var $cover = $album->getCoverPhoto()}
									
									<div class="albumInfo">
										<div class="albumCamera">{$album->getPhotosCount()}</div>
										<div class="albumName">{$album->getName()}</div>
									</div>
									<img
										src="{is_null($cover)?'/themepack/vkify/2.0.0.0/resource/m_noalbum.png':$cover->getURLBySizeId('small')}"
										style="{is_null($cover)?'':'width: 178px;'|noescape}"
										class="albumPreview" loading=lazy />
								</div>
							</a>
						</div>
					</div>
				</div>
			</a>
			<a href="/videos{$user->getId()}" n:if="$videosCount > 0 && $user->getPrivacyPermission('videos.read', $thisUser ?? NULL)">
				<div>
					<div class="content_title_expanded">
						{_videos}
					</div>
					<div>
						<div class="content_subtitle">
							{tr("videos", $videosCount)}
						</div>
						<div style="padding: 5px;">
							<div class="ovk-video" n:foreach="$videos as $video">
								<a href="/video{$video->getPrettyId()}" class="preview" align="center" id="videoOpen" data-id="{$video->getPrettyId()}">
									<img
										src="{$video->getThumbnailURL()}"
										style="max-width: 170px; max-height: 127px; margin: auto;" />
								</a>
								<div>
									<b><a href="/video{$video->getPrettyId()}" id="videoOpen" data-id="{$video->getPrettyId()}">{ovk_proc_strtr($video->getName(), 30)}</a></b><br>
									<span style="font-size: 10px;">{$video->getPublicationTime()} | {_comments} ({$video->getCommentsCount()})</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			</a>
			<a href="/notes{$user->getId()}" n:if="$notesCount > 0 && $user->getPrivacyPermission('notes.read', $thisUser ?? NULL)">
				<div>
					<div class="content_title_expanded">
						{_notes}
					</div>
					<div>
						<div class="content_subtitle">
							{tr("notes", $notesCount)}
						</div>
						
						<div style="padding: 5px 8px 15px 8px;">
							<ul class="notes_titles" n:foreach="$notes as $note">
								<li class="written">
									<a href="/note{$note->getPrettyId()}">
										{$note->getName()}
									</a>
									<small>
										{$note->getPublicationTime()}
										<span class="divide">|</span>
										<a href="/note{$note->getPrettyId()}">{_comments}</a>
									</small>
								</li>
							</ul>
						</div>
					</div>
				</div>
			</a>
			<a href="/groups{$user->getId()}" n:if="$user->getClubCount() > 0 && $user->getPrivacyPermission('groups.read', $thisUser ?? NULL)">
				<div>
					{var $clubsCount = $user->getClubCount()}
					<div class="content_title_expanded">
						{_groups}
					</div>
					<div>
						<div class="content_subtitle">
							{tr("groups", $clubsCount)}
						</div>
						<div class="profileGroup" n:foreach="array_slice(($clubs = iterator_to_array($user->getClubs(1))) && shuffle($clubs) ? $clubs : $clubs, 0, 5) as $club">
							<div style="display: inline;">
								<div class="thumb_ava32">
									<a href="club{$club->getId()}" style="">
										<img src="{$club->getAvatarUrl()}" />
									</a>
								</div>
								<div class="groupInfoName"><a href="club{$club->getId()}" style="">{$club->getName()}</a></div>
								<div class="groupInfoDesc">
									<span>{$club->getDescription()}</span>
								</div>
							</div>
						</div>
					</div>
				</div>
			</a>
			<a href="/groups{$user->getId()}?act=meetings" n:if="$user->getMeetingCount() > 0 && $user->getPrivacyPermission('groups.read', $thisUser ?? NULL)">
				<div>
					{var $meetingCount = $user->getMeetingCount()}
					<div class="content_title_expanded">
						{_meetings}
					</div>
					<div>
						<div class="content_subtitle">
							{tr("meetings", $meetingCount)}
						</div>
						<div style="padding-left: 5px;">
							<div style="display: inline;" n:foreach="$user->getMeetings(1) as $meeting">
								<a href="/event{$meeting->getId()}">{$meeting->getName()}</a> {if !$iterator->last}•{/if}
							</div>
						</div>
					</div>
				</div>
			</a>
		</div>
    </div>
    
    <div class="right_big_block">
        <div class="page_info">
            <div n:if="!is_null($alert = $user->getAlert())" class="user-alert">{strpos($alert, "@") === 0 ? tr(substr($alert, 1)) : $alert}</div>
            {var $thatIsThisUser = isset($thisUser) && $user->getId() == $thisUser->getId()}
            <div n:if="$thatIsThisUser" class="page_status_popup" id="status_editor" style="display: none;">
                <form name="status_popup_form" onsubmit="changeStatus(); return false;">
                    <div style="margin-bottom: 10px;">
                        <input type="text" name="status" size="50" value="{$user->getStatus()}" />
                        <label style="width: 316px;display: block;">
                            <input type="checkbox" name="broadcast" n:attr="checked => $user->isBroadcastEnabled()" />
                            {_broadcast_audio}
                        </label>
                    </div>
                    <input type="hidden" name="hash" value="{$csrfToken}" />
                    <button type="submit" name="submit" class="button" style="height: 25px;">{_send}</button>
                </form>
            </div>
			<div class="accountInfo clearFix">
                <div class="profileName">
                    <h2>{$user->getFullName()}</h2>

                    {if !$audioStatus}
                        {if !is_null($user->getStatus())}
                            <div n:class="page_status, $thatIsThisUser ? page_status_edit_button" n:attr="id => $thatIsThisUser ? page_status_text : NULL">{$user->getStatus()}</div>
                        {elseif $thatIsThisUser}
                            <div class="page_status">
                                <div n:class="edit_link, $thatIsThisUser ? page_status_edit_button" id="page_status_text">{_change_status}</div>
                            </div>
                        {/if}
                    {else}
                        <div class="page_status" style="display: flex;">
                            <div n:class="audioStatus, $thatIsThisUser ? page_status_edit_button" id="page_status_text">
                                {$audioStatus->getName()}
                            </div>
                        </div>
                    {/if}
                </div>
            </div>
            <div>
                <table id="basicInfo" class="ugc-table" border="0" cellspacing="0" cellpadding="0" border="0" cellspacing="0" cellpadding="0" n:if=" $user->getPrivacyPermission('page.info.read', $thisUser ?? NULL)">
                    <tbody>
                        <tr>
                            <td class="label"><span class="nobold">{_pronouns}: </span></td>
                            <td class="data">{$user->isFemale() ? tr("female") : ($user->isNeutral() ? tr("neutral") : tr("male"))}</td>
                        </tr>
                        <tr>
                            <td class="label"><span class="nobold">{_relationship}:</span></td>
                            <td class="data">
                                {$user->getLocalizedMaritalStatus()}
                                {if $user->getMaritalStatusUser()}
                                    {$user->getMaritalStatusUserPrefix()}
                                    <a href="{$user->getMaritalStatusUser()->getURL()}" target="_blank">
                                        {$user->getMaritalStatusUser()->getCanonicalName()}
                                    </a>
                                {/if}
                            </td>
                        </tr>
                        <tr>
                            <td class="label"><span class="nobold">{_registration_date}: </span></td>
                            <td class="data">{$user->getRegistrationTime()}</td>
                        </tr>
                        <tr n:if="!is_null($user->getHometown())">
                            <td class="label"><span class="nobold">{_hometown}:</span></td>
                            <td class="data"><a href="/search?section=users&q=&hometown={urlencode($user->getHometown())}">{$user->getHometown()}</a></td>
                        </tr>
                        <tr>
                            <td class="label"><span class="nobold">{_politViews}:</span></td>
                            <td class="data">{var $pviews = $user->getPoliticalViews()}{_"politViews_$pviews"}</td>
                        </tr>
                        <tr n:if="!is_null($user->getBirthday())">
                            <td class="label"><span class="nobold">{_birth_date}:</span></td>
                            <td n:if="$user->getBirthdayPrivacy() == 0" class="data">{$user->getBirthday()->format('%e %B %Y')},
                                {tr("years", $user->getAge())}</td>
                            <td n:if="$user->getBirthdayPrivacy() == 1" class="data">{$user->getBirthday()->format('%e %B')}</td>
                        </tr>
                    </tbody>
                </table>
			</div>
        </div>
        <div n:if="$user->getPrivacyPermission('page.info.read', $thisUser ?? NULL)">
            <a class="profile_info" onclick="switchProfileInfo();" id="showFullInfoButton">{tr('show_comments')}</a>
            <div class="profileinfoblock" style="display:none;">
				{capture $contactInfo_Tmp}
					<table class="ugc-table" border="0" cellspacing="0" cellpadding="0" border="0" cellspacing="0" cellpadding="0" n:ifcontent>
					  <tbody n:ifcontent>
							<tr n:if="!is_null($user->getContactEmail())">
								<td class="label"><span class="nobold">{_email}: </span></td>
								<td>
									<a href="mailto:{$user->getContactEmail()}" rel="ugc">
										{$user->getContactEmail()}
									</a>
								</td>
							</tr>
							<tr n:if="!is_null($user->getTelegram())">
								<td class="label"><span class="nobold">{_telegram}: </span></td>
								<td>
									<a href="https://t.me/{$user->getTelegram()}" rel="ugc" target="_blank">
										@{$user->getTelegram()}
									</a>
								</td>
							</tr>
							<tr n:if="!is_null($user->getWebsite())">
								<td class="label"><span class="nobold">{_personal_website}: </span></td>
								<td>
									<a href="{$user->getWebsite()}" rel="ugc" target="_blank">
										{$user->getWebsite()}
									</a>
								</td>
							</tr>
						<tr n:if="!is_null($user->getCity())">
							<td class="label"><span class="nobold">{_city}:</span></td>
							<td class="data"><a href="/search?type=section&q=&city={$user->getCity()}">{$user->getCity()}</a></td>
						</tr>
						<tr n:if="!is_null($user->getPhysicalAddress())">
							<td class="label"><span class="nobold">{_address}:</span></td>
							<td class="data">{$user->getPhysicalAddress()}</td>
						</tr>
						{if $additionalFields}
							<tr n:foreach="$additionalFields['contacts'] as $field">
								<td class="label"><span class="nobold">{$field->getName()}:</span></td>
								<td class="data">{$field->getContent()}</td>
							</tr>
						{/if}
					  </tbody>
					</table>
				{/capture}
				{capture $uInfo_Tmp}
					<table class="ugc-table" border="0" cellspacing="0" cellpadding="0" border="0" cellspacing="0" cellpadding="0" n:ifcontent>
					  <tbody n:ifcontent>
						<tr n:if="!is_null($user->getInterests())">
							<td class="label"><span class="nobold">{_interests}: </span></td>
							<td class="data">
								{var $interests = explode(", ", $user->getInterests())}
								
								{foreach $interests as $interest}
									<span>{$interest}</span>{if $interest != end($interests)},{/if}
								{/foreach}
							</td>
						</tr>
						<tr n:if="!is_null($user->getFavoriteMusic())">

							<td class="label"><span class="nobold">{_favorite_music}: </span></td>
							<td class="data">
								{var $musics = explode(", ", $user->getFavoriteMusic())}

								{foreach $musics as $music}
									<a href="/search?section=audios&q={urlencode($music)}">{$music}</a>{if $music != end($musics)},{/if}
								{/foreach}
							</td>
						</tr>
						<tr n:if="!is_null($user->getFavoriteFilms())">
							<td class="label"><span class="nobold">{_favorite_films}: </span></td>
							<td class="data">
								{var $films = explode(", ", $user->getFavoriteFilms())}

								{foreach $films as $film}
									<a href="/search?section=users&q=&fav_films={urlencode($film)}">{$film}</a>{if $film != end($films)},{/if}
								{/foreach}
							</td>
						</tr>
						<tr n:if="!is_null($user->getFavoriteShows())">
							<td class="label"><span class="nobold">{_favorite_shows}: </span></td>
							<td class="data">                        
								{var $shows = explode(", ", $user->getFavoriteShows())}

								{foreach $shows as $show}
									<a href="/search?section=users&q=&fav_shows={urlencode($show)}">{$show}</a>{if $show != end($shows)},{/if}
								{/foreach}
							</td>
						</tr>
						<tr n:if="!is_null($user->getFavoriteBooks())">
							<td class="label"><span class="nobold">{_favorite_books}: </span></td>
							<td class="data">
								{var $books = explode(", ", $user->getFavoriteBooks())}

								{foreach $books as $book}
									<a href="/search?section=users&q=&fav_books={urlencode($book)}">{$book}</a>{if $book != end($books)},{/if}
								{/foreach}
							</td>
						</tr>
						<tr n:if="!is_null($user->getFavoriteQuote())">
							<td class="label"><span class="nobold">{_favorite_quotes}: </span></td>
							<td class="data">{$user->getFavoriteQuote()}</td>
						</tr>
						<tr n:if="!is_null($user->getFavoriteGames())">
							<td class="label"><span class="nobold">{_favorite_games}: </span></td>
							<td class="data">{$user->getFavoriteGames()}</td>
						</tr>
						{if $additionalFields}
							<tr n:foreach="$additionalFields['interests'] as $field">
								<td class="label"><span class="nobold">{$field->getName()}:</span></td>
								<td class="data">{$field->getContent()}</td>
							</tr>
						{/if}
						<tr n:if="!is_null($user->getDescription())">
							<td class="label"><span class="nobold">{_information_about}: </span></td>
							<td class="data">{$user->getDescription()}</td>
						</tr>
					  </tbody>
					</table>
				{/capture}
				<div>
				<div style="padding: 10px 8px 15px 8px;" n:ifcontent>
					<h4 style="border-bottom: none; font-size: 11px; padding: 0; display: inline-block; width: 100%; display: flex; align-items: center;"><text style="max-width: fit-content;">{_contact_information}</text><div class="editline"></div> {ifset $thisUser}{if $thisUser->getId() == $user->getId()}<a href="/edit?act=contacts" class="edit_link" style="text-transform: lowercase;">{_edit}</a>{/if}{/ifset}</h4>
					{if !empty($contactInfo_Tmp)}
						{$contactInfo_Tmp|noescape}
					{else}
						<div style="padding: 15px;color:gray;text-align: center;">{_no_information_provided}</div>
					{/if}
					<br>
					<h4 style="border-bottom: none; font-size: 11px; padding: 0; display: inline-block; width: 100%; display: flex; align-items: center;"><text style="max-width: fit-content;">{_personal_information}</text><div class="editline"></div> {ifset $thisUser}{if $thisUser->getId() == $user->getId()}<a href="/edit?act=interests" class="edit_link" style="text-transform: lowercase;">{_edit}</a>{/if}{/ifset}</h4>
					{if !empty($uInfo_Tmp)}
						{$uInfo_Tmp|noescape}
					{else}
						<div style="padding-top: 15px;color:gray;text-align: center;">{_no_information_provided}</div>
					{/if}
				</div>
				</div>
			</div>
		</div>
		
		<div n:if="((new \openvk\Web\Models\Repositories\Photos())->getUserPhotosCount($user) > 0 && $user->getPrivacyPermission('photos.read', $thisUser ?? NULL)) || (isset($thisUser) && $user->getId() == $thisUser->getId())">
			<a href="/albums{$user->getId()}">
				<div class="content_title_expanded">
					{_mobile_photos}
				</div>
			</a>
			<div>
				<a href="/albums{$user->getId()}">
					<div class="content_subtitle">
						{(new \openvk\Web\Models\Repositories\Photos())->getUserPhotosCount($user)} {tr('photos')}
					</div>
				</a>
				<div style="padding: 0px 0px 0px 0px; text-align: center;">
				{if (new \openvk\Web\Models\Repositories\Photos())->getUserPhotosCount($user) > 0 }
					<table style="border-collapse: collapse; text-align: center;margin: auto;margin-top: 5px;">
						<tbody><tr>
							<td style="padding: 1.5px; text-align: center;" n:foreach="($photos = iterator_to_array((new \openvk\Web\Models\Repositories\Photos())->getEveryUserPhoto($user, 0, 5))) as $photo">
								<a href="{$photo->getPageURL()}">
								    <div style="width: 100%; height: 100%">
										<img
											src="{$photo->getURLBySizeId('tiny')}"
											onclick="OpenMiniature(event, {$photo->getURLBySizeId('larger')}, null, {$photo->getPrettyId()}, null)"
											class="albumPreview" loading=lazy style="max-width: 75px; max-height: 75px;"/>
									</div>
								</a>
							</td>
						</tr></tbody>
					</table>
				{else}
					{if isset($thisUser) && $user->getId() == $thisUser->getId()}
						<a href="/albums/create">
							<div class="noPhotosTip"><div class="addPhotoTip">{_add_photos}</div></div>
						</a>
					{/if}
				{/if}
				</div>
			</div>
		</div>
        
        {presenter "openvk!Wall->wallEmbedded", $user->getId()}
        
        <script n:if="isset($thisUser) && $thisUser->getChandlerUser()->can('access')->model('admin')->whichBelongsTo(NULL)">
            function banUser() {
                uBanMsgTxt  = "Вы собираетесь забанить пользователя " + {$user->getCanonicalName()} + ".";
                uBanMsgTxt += "<br/><b>Предупреждение</b>: Это действие удалит все подписки пользователя и отпишет всех от него.";
                uBanMsgTxt += "<br/><br/><b>Причина бана</b>: <input type='text' id='uBanMsgInput' placeholder='придумайте что-нибудь крутое' />"
                uBanMsgTxt += "<br/><br/><b>Заблокировать до</b>: <input type='date' id='uBanMsgDate' />";
                uBanMsgTxt += "<br/><br/><input id='uBanMsgIncr' type='checkbox' checked='1'/>Автоматически <b>(до " + {date('d.m.Y H\h', time() + $user->getNewBanTime())} + ")</b>";

                MessageBox("Забанить " + {$user->getFirstName()}, uBanMsgTxt, ["Подтвердить", "Отмена"], [
                    (function() {
                        res = document.querySelector("#uBanMsgInput").value;
                        date = document.querySelector("#uBanMsgDate").value;
                        incr = document.querySelector("#uBanMsgIncr").checked ? '1' : '0';
                        xhr = new XMLHttpRequest();
                        xhr.open("GET", "/admin/ban/" + {$user->getId()} + "?reason=" + res + "&incr=" + incr + "&date=" + date + "&hash=" + {rawurlencode($csrfToken)}, true);
                        xhr.onload = (function() {
                            if(xhr.responseText.indexOf("success") === -1)
                                MessageBox("Ошибка", "Не удалось забанить пользователя...", ["OK"], [Function.noop]);
                            else
                                MessageBox("Операция успешна", "Пользователь заблокирован", ["OK"], [Function.noop]);
                        });
                        xhr.send(null);
                    }),
                    Function.noop
                ]);
            }
            
            function warnUser() {
                uBanMsgTxt  = "Вы собираетесь предупредить пользователя " + {$user->getCanonicalName()} + ".";
                uBanMsgTxt += "<br/>Мы отправим уведомление пользователю в личные сообщения от имени аккаунта администратора.";
                uBanMsgTxt += "<br/><br/><b>Текст предупреждения</b>: <input type='text' id='uWarnMsgInput' placeholder='придумайте что-нибудь крутое' />";
                
                MessageBox("Выдать предупреждение " + {$user->getFirstName()}, uBanMsgTxt, ["Подтвердить", "Отмена"], [
                    (function() {
                        res = document.querySelector("#uWarnMsgInput").value;
                        xhr = new XMLHttpRequest();
                        xhr.open("GET", "/admin/warn/" + {$user->getId()} + "?message=" + res + "&hash=" + {rawurlencode($csrfToken)}, true);
                        xhr.onload = (function() {
                            if(xhr.responseText.indexOf("message") === -1)
                                MessageBox("Ошибка", "Не удалось отправить предупреждение...", ["OK"], [Function.noop]);
                            else
                                MessageBox("Операция успешна", "Предупреждение отправлено", ["OK"], [Function.noop]);
                        });
                        xhr.send(null);
                    }),
                    Function.noop
                ]);
            }
        </script>

        <script n:if="isset($thisUser) && $thisUser->getChandlerUser()->can('write')->model('openvk\Web\Models\Entities\TicketReply')->whichBelongsTo(0)">
            {if $user->isBannedInSupport()}
                function toggleBanInSupport() {
                    uBanMsgTxt  = "Вы собираетесь разблокировать в поддержке пользователя " + {$user->getCanonicalName()} + ".";
                    uBanMsgTxt += "<br/>Сейчас он заблокирован по причине <strong>" + {$user->getBanInSupportReason()} + "</strong>.";

                    MessageBox("Разблокировать в поддержке " + {$user->getFirstName()}, uBanMsgTxt, ["Подтвердить", "Отмена"], [
                        (function() {
                            xhr = new XMLHttpRequest();
                            xhr.open("GET", "/admin/support/unban/" + {$user->getId()} + "?hash=" + {rawurlencode($csrfToken)}, true);
                            xhr.onload = (function() {
                                if(xhr.responseText.indexOf("success") === -1)
                                    MessageBox("Ошибка", "Не удалось разблокировать пользователя в поддержке...", ["OK"], [Function.noop]);
                                else
                                    MessageBox("Операция успешна", "Пользователь разблокирован в поддержке", ["OK"], [Function.noop]);
                            });
                            xhr.send(null);
                        }),
                        Function.noop
                    ]);
                }
            {else}
                function toggleBanInSupport() {
                    uBanMsgTxt  = "Вы собираетесь заблокировать в поддержке пользователя " + {$user->getCanonicalName()} + ".";
                    uBanMsgTxt += "<br/><br/><b>Причина бана</b>: <input type='text' id='uBanMsgInput' placeholder='придумайте что-нибудь крутое' />";
                    uBanMsgTxt += "<br/><br/><input type='checkbox' id='uBanClsTicketsInput' /><label for='uBanClsTicketsInput'>Закрыть все обращения пользователя</label>";

                    MessageBox("Заблокировать в поддержке " + {$user->getFirstName()}, uBanMsgTxt, ["Подтвердить", "Отмена"], [
                        (function() {
                            res = document.querySelector("#uBanMsgInput").value;
                            cls = document.querySelector("#uBanClsTicketsInput").value;
                            xhr = new XMLHttpRequest();
                            xhr.open("GET", "/admin/support/ban/" + {$user->getId()} + "?reason=" + res + "&close_tickets=" + cls + "&hash=" + {rawurlencode($csrfToken)}, true);
                            xhr.onload = (function() {
                                if(xhr.responseText.indexOf("success") === -1)
                                    MessageBox("Ошибка", "Не удалось заблокировать пользователя в поддержке...", ["OK"], [Function.noop]);
                                else
                                    MessageBox("Операция успешна", "Пользователь заблокирован в поддержке", ["OK"], [Function.noop]);
                            });
                            xhr.send(null);
                        }),
                        Function.noop
                    ]);
                }
            {/if}
        </script>
    </div>
    
    {/if}
    
    {else} {* isBanned() *}
        {include "banned.xml"}
    {/if}
{/block}
