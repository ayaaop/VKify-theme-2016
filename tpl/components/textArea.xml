{php if(!isset($GLOBALS["textAreaCtr"])) $GLOBALS["textAreaCtr"] = 10;}
{var $textAreaId = ($post ?? NULL) === NULL ? (++$GLOBALS["textAreaCtr"]) : $post->getId()}
{var $textAreaId = ($custom_id ?? NULL) === NULL ? $textAreaId : $custom_id}
{var $anonEnabled = OPENVK_ROOT_CONF['openvk']['preferences']['wall']['anonymousPosting']['enable']}
{var $anonAccountId = OPENVK_ROOT_CONF['openvk']['preferences']['wall']['anonymousPosting']['account'] ?? 100}
{var $anonUser = $anonEnabled ? (new \openvk\Web\Models\Repositories\Users())->get($anonAccountId) : NULL}

<div id="write" class='model_content_textarea' style="padding: 4px 1px 2px 1px;">
    <form action="{$route}" method="post" enctype="multipart/form-data" style="margin:0;">
    {if $thisUser ?? NULL}
        <a class="post_field_user_link _post_field_author" href="{$thisUser->getURL()}">
            <!-- User avatar image - visible by default -->
            <img class="post_field_user_image _post_field_user_image"
                    src="{$thisUser->getAvatarUrl('miniscule')}"
                    alt="{$thisUser->getCanonicalName()}"
                    width="28" height="28"
                    data-user-url="{$thisUser->getURL()}" />
            <!-- Group avatar image - hidden by default -->
            {if !is_null($club ?? NULL)}
            <img class="post_field_user_image _post_field_group_image"
                    src="{if str_contains($club->getAvatarUrl('miniscule'), 'camera_200.png')}/themepack/vkify16/1.0.0.0/resource/community_200.png{else}{$club->getAvatarUrl('miniscule')}{/if}"
                    alt="{$club->getCanonicalName()}"
                    width="28" height="28"
                    style="opacity: 0;"
                    data-group-url="{$club->getURL()}" />
            {/if}
            <!-- Anonymous avatar image - hidden by default -->
            {if $anonEnabled && $anonUser}
            <img class="post_field_user_image _post_field_anon_image"
                    src="{$anonUser->getAvatarUrl('miniscule')}"
                    alt="{$anonUser->getCanonicalName()}"
                    width="28" height="28"
                    style="opacity: 0;"
                    data-anon-url="{$anonUser->getURL()}" />
            {/if}

        </a>
    {/if}
        <textarea id="wall-post-input{$textAreaId}" placeholder="{_write}" name="text"
            style="resize: none;" class="small-textarea"></textarea>
        <div id="post-buttons{$textAreaId}" class='post-buttons'>
            <div class="post-horizontal"></div>
            <div class="post-vertical"></div>
            <div class="post-has-poll">
                {_poll}
            </div>
            <div class="post-has-geo"></div>
            <div class="post-source"></div>

            <input type="hidden" name="horizontal_attachments" value="" autocomplete="off" />
            <input type="hidden" name="vertical_attachments" value="" autocomplete="off" />
            <input type="hidden" name="poll" value="none" autocomplete="off" />
            <input type="hidden" id="source" name="source" value="none" autocomplete="off" />
            <input type="hidden" name="geo" value="" autocomplete="off" />
            <input type="hidden" name="type" value="1" autocomplete="off" />
            <input type="hidden" name="hash" value="{$csrfToken}" />
            <div class="post-bottom-acts">
                <div class="post-attach-menu">
                    <div id="wallAttachmentMenu">
                        <a id="__photoAttachment" title="{_photo}"
                           {if !is_null($club ?? NULL) && $club->canBeModifiedBy($thisUser)}data-club="{$club->getId()}"{/if}>
                            <div class="post-attach-menu__icon"></div>
                        </a>
                        <a id="__videoAttachment" title="{_video}">
                            <div class="post-attach-menu__icon"></div>
                        </a>
                        <a id="__audioAttachment" title="{_audio}">
                            <div class="post-attach-menu__icon"></div>
                        </a>

                        <a class="post-attach-menu__trigger" id="moreAttachTrigger">
                            {_show_more}
                        </a>
                        <div class="tippy-menu" id="moreAttachTooltip">
                            <a n:if="$docs ?? true" id="__documentAttachment"
                               {if !is_null($club ?? NULL) && $club->canBeModifiedBy($thisUser)}data-club="{$club->getRealId()}"{/if}>
                                <div class="post-attach-menu__icon"></div>
                                {_document}
                            </a>
                            <a n:if="$notes ?? false" id="__notesAttachment">
                                <div class="post-attach-menu__icon"></div>
                                {_note}
                            </a>
                            <a n:if="$graffiti ?? false" id="__graffitiAttachment" onclick="window.vkifyGraffiti(event);">
                                <div class="post-attach-menu__icon"></div>
                                {_graffiti}
                            </a>
                            <a n:if="$polls ?? false" id="__pollAttachment" onclick="initPoll(event);">
                                <div class="post-attach-menu__icon"></div>
                                {_poll}
                            </a>
                            <a n:if="$geo ?? false" id="__geoAttacher">
                                <div class="post-attach-menu__icon"></div>
                                {_geo_place}
                            </a>
                            <a n:if="$hasSource ?? false" id="__sourceAttacher">
                                <div class="post-attach-menu__icon"></div>
                                {_source}
                            </a>
                        </div>
                    </div>
                </div>
                <div class="post-bottom-buttons">
                    {if $postOpts ?? true}
                        <div class="post_settings" id="postOptsTrigger" role="button">
                            <div class="common_icon"></div>
                        </div>
                
                        <div class="post-opts" id="postOptsTooltip">
                            {if !is_null($thisUser) && !is_null($club ?? NULL) && $owner < 0 && $club->canBeModifiedBy($thisUser)}
                                <script>
                                    function onWallAsGroupClick(el) {
                                        document.querySelector("#forceSignOpt").style.display = el.checked ? "block" : "none";
                                        {if $anonEnabled}
                                            document.querySelector("#octoberAnonOpt").style.display = el.checked ? "none" : "block";                                            
                                        {/if}

                                        // Call the main handler in patch_wall.js
                                        if (window.handleWallAsGroupClick) {
                                            window.handleWallAsGroupClick(el);
                                        }
                                    }

                                    function onWallAnonClick(el) {
                                        {if $anonEnabled}
                                            const asGroupCheckbox = document.querySelector('input[name="as_group"]');
                                            if (asGroupCheckbox) {
                                                asGroupCheckbox.disabled = el.checked;
                                            }
                                        {/if}

                                        // Call the main handler in patch_wall.js
                                        if (window.handleWallAnonClick) {
                                            window.handleWallAnonClick(el);
                                        }
                                    }
                                </script>
                                <label>
                                    <input type="checkbox" name="as_group" onchange="onWallAsGroupClick(this)" />
                                    {_post_as_group}
                                </label>
                                <label id="forceSignOpt" style="display: none;">
                                    <input type="checkbox" name="force_sign" /> {_add_signature}
                                </label>
                            {/if}
                
                            <label n:if="$anonEnabled" id="octoberAnonOpt">
                                <input type="checkbox" name="anon" onchange="onWallAnonClick(this)" /> {_as_anonymous}
                            </label>
                
                            <label>
                                <input type="checkbox" name="nsfw" /> {_contains_nsfw}
                            </label>
                        </div>
                    {/if}
                    <input type="submit" value="{_write}" class="button" />
                </div>
            </div>
        </div>
    </form>
</div>